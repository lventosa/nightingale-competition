---
title: 'Florence Nightingale Competition 2020 - RLadies Spain'
author: "Authors: Laura Ventosa & Esther Manzano"
date: "July 2020"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
  pdf_document:
    highlight: zenburn
    toc: yes
  word_document: default
---
```{r setup, include = FALSE, cache = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE) #Escrivint en aquesta línia el que està entre parèntesis, aquestes opcions es converteixen en globals per tot els blocs de codi del document. Les deixo aquí i les esborro individualment de cada bloc perquè quedi més net
``` 


*****
## Index
*****

1. Data file upload and brief description

  1.1.  Analysis of qualitative variables & graphic representation

  1.2.  Analysis of quantitative variables & graphic representation

  1.3.  Missing values

  1.4.  Outliers
  
2. Plots --> Podríem petar-nos aquest apartat si ja hem representat plts en els apartats 1.1 i 1.2

3. Regressions

4. Predictions

5. Conclusions


(És part de l'índex això o s'ha colat? jajaj)
2. Inferencial statistics: Confidence intervals of X variable

3. Proporció de nens i nenes

	3.1.	Hypothesis

	3.2.	Method

	3.3.	Calculation
	
	3.4.  Interpretation


*****
## 1. Data file upload and brief description
*****

We check the different types of data on our dataset. The aim is to understand the nature of our variables (i.e. the proportion of numerical and categorical variables) to be able to develope a better model afterwards. We will check if we have missing values and outliers as well.
```{r}
# Libraries used across the whole project:     (haurem de revisar quins no fem servir al final i treure'ls)
library(readxl)
library(tidyverse)
library(viridis)
library(dygraphs)
library(xts) 
library(lmtest)
library(ResourceSelection)
library(pROC)
#library(kableExtra)
#library(ggpubr)
#library(DescTools)

# Importing dataset:
data <- read_excel("../nightingale-competition/datos_florence.xlsx", skip=1)
```
```{r}
# Basic information:
head(data)
```
```{r}
# Dimensions of our dataset
dim(data)
```
```{r}
sapply(data, class) #Per no repetir-nos amb la funció anterior podem eliminar eliminar str() i deixar sapply() que queda més net jajaja 
```
```{r}
summary(data)
```
```{r}
#Creating a numeric variable to account for time period
L <- nrow(data)
time_period <- seq(0,(L-1)) #Podríem passar-ho de 1 a L
data$time_period <- time_period
data <- as.data.frame(data)
```
```{r}
#Making everything more readable and column names more manageable
colnames(data)[1] <- "month"
colnames(data)[2] <- "avg_size_army"
colnames(data)[3] <- "zymotic"
colnames(data)[4] <- "injuries"
colnames(data)[5] <- "other"
colnames(data)[6] <- "zymotic_rate"
colnames(data)[7] <- "injuries_rate"
colnames(data)[8] <- "other_rate"
```
```{r}
#Adding new variables to the dataset:
deaths <- vector() 
for(i in 1:L){
  deaths[i] <- data$zymotic[i] + data$injuries[i] + data$other[i]
}
data$total_deaths <- deaths #Agreggated deaths (all causes) per month

cum_deaths <- vector()
cum_deaths <- cumsum(deaths)
data$cum_deaths <- cum_deaths #Cumulative deaths over time
```

1.1. Analysis of qualitative variables & graphic representation

```{r}

```

1.2. Analysis of quantitative variables & graphic representation

```{r}
# Correlations (mirar com ho deixem)
cor(data$avg_size_army, data$zymotic)  
cor(data$avg_size_army, data$injuries)
cor(data$avg_size_army, data$other)
cor(data$avg_size_army, data$total_deaths)
```

1.3. Missing values

```{r}
# Checking missing values:
colSums(is.na(data)) 
```
As we can see, there are no NA values in our dataset.

1.4. Outliers

```{r}
boxplot(injuries~avg_size_army, data, main="Injuries vs Avg Size of Army", xlab="Avg size of army", ylab="Deaths by injury")
boxplot(zymotic~avg_size_army, data, main="Zymotic vs Avg Size of Army", xlab="Avg size of army", ylab="Deaths by zymotic disease")
boxplot(other~avg_size_army, data, main="Other vs Avg Size of Army", xlab="Avg size of army", ylab="Deaths by other causes")
#Els boxplots se'm veuen com només ratlles horitzontals. Probablement sigui perquè avg_size_army no categoritza lo suficient. Millor així?:

boxplot(data$injuries, col="lightgoldenrod", main="Deaths by injuries")
boxplot(data$zymotic, col="mistyrose", main="Deaths by zymotic disease")
boxplot(data$other, col="powderblue", main="Deaths by other causes")
#He intentat encabir les tres caixes en un sol plot però no he aconseguit que quedessin quadrades les labels a l'eix horitzontal amb el nom de cada variable
```


*****
## 2. Plots
*****

```{r}
#Millor fer servir time_period però transformant la data amb xts() queda l'eix x amb dates al gràfic dinàmic
data_plot_1 <- data.frame(
  time=data$time_period, 
  Zymotic=data$zymotic, 
  Injuries=data$injuries,
  Other=data$other)
dygraph(data_plot_1, main="Death causes (absolute values)")

data_plot_2 <- data.frame(
  time=data$time_period,
  Zymotic=data$zymotic_rate, 
  Injuries=data$injuries_rate,
  Other=data$other_rate)
dygraph(data_plot_2, main="Death causes (rates)")

data_plot_3 <- data.frame(
  time=data$time_period,
  Army=data$avg_size_army)
dygraph(data_plot_3, main="Average size of the army")
```
```{r}
data_plot_4 <- data.frame(
  time=data$time_period,
  Accumulated_deaths=cum_deaths) #No m'acaba d'agradar el nom de la variable top-right. Millor data amb xts()?
dygraph(data_plot_4, main="Accumulated number of deaths")
```

*****
## 3. Regressions
*****

```{r}
tra_death <- data.frame(y=data$total_deaths[2:L], lag1=data$total_deaths[1:(L-1)]) 
reg1 <- lm(y ~ lag1, data=tra_death) #Regressió morts avui en funció de les morts d'ahir
summary(reg1)
```
```{r}
reg2 <- lm(data$total_deaths ~ data$time_period, data=data)
summary(reg2) #No significació del time period sobre total deaths
```
```{r}
#Accuracy de reg1 per fer prediccions (he provat de fer la del número de morts basant-me només en un lag d'aquesta mateixa variable per provar de fer-ne alguna)
train_data <- subset(data, time_period<=round(0.7*L)) #70% training data
test_data <- subset(data, time_period>round(0.7*L)) #30% test/validation data
training1 <- data.frame(y=train_data$total_deaths, lag1=train_data$total_deaths) 
model1 <- lm(y ~ lag1, data=training1)
y.hat1 <- predict(model1, data=test_data)
error1 <- abs(y.hat1 - test_data$total_deaths)
rmse1 <- sqrt((sum(error1)**2)/nrow(test_data)) 
#Fatal performance, tampoc sé si té gaire sentit predir el número de morts futures a partir de les del dia anterior, ens caldria algo amb més chicha
```
```{r}
# Diagnosi dels models:
residual.values <- rstandard(reg1) 
adjusted.values <- fitted(reg1) 
plot(adjusted.values, residual.values)
```
```{r}
qqnorm(residual.values) 
qqline(residual.values)

#A la vista del gràfic, no s’observa cap patró especial, de manera que tant la homocedasticitat com la linealitat resulten hipòtesis raonables.
#D’altra banda, el Q_Q plot mostra que les dades no s’ajusten bé a una normal.
```
```{r}
reg3 <- glm(formula=data$avg_size_army~data$injuries, data=data) 
summary(reg3)
```
```{r}
exp(coefficients(reg3))
```
```{r}
exp(confint(reg3))
```
```{r}
reg4 <- glm(formula=data$avg_size_army~data$zymotic, data=data) 
summary(reg4)
```
```{r}
# Basant-se l’indicador AIC, s’observa que és més gran que en el model anterior, de manera que NO hi ha una millora en l’ajust. PERQUÈ NI INJURIES NI ZYMOTIC SON FACTORS SIGNIFICATIUS DE ARMY SIZE?
```


*****
## 4. Predictions
*****

```{r}
# Ho hem de fer amb un model que funcioni però... Quina seria la probabilitat de X si Y és això i Z és això altre?
pred<-predict(reg1, data.frame(Y="1",Z=90),type = "response")
pred
```
```{r}
# Calculem la bondat de l'ajust: <- s'ha de tocar la data
hoslem.test(X,fitted(modelX))
```
```{r}
# Dibuixem la corba ROC: <- s'ha de tocar la data
prob_low=predict(logit_model_2, datA3, type="response")
r=roc(BW_RE,prob_low, data=datA3)
```